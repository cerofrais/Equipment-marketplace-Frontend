name: Build and Release Web App

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual trigger

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Create .env file
        run: |
          echo "BASE_URL=${{ secrets.BASE_URL }}" > .env
          echo ".env file created"

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test
        continue-on-error: true

      - name: Build Web App
        run: flutter build web --release --web-renderer canvaskit

      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Build: $BUILD_NUMBER"

      - name: Generate release tag
        id: tag
        run: |
          TAG="web-v${{ steps.version.outputs.version }}-build.${{ steps.version.outputs.build_number }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Create web build archive
        run: |
          cd build
          zip -r ../equipverse-web-${{ steps.version.outputs.version }}.zip web/
          cd ..
          echo "Archive created: equipverse-web-${{ steps.version.outputs.version }}.zip"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: EquipVerse Web v${{ steps.version.outputs.version }} (Build ${{ steps.version.outputs.build_number }})
          body: |
            ## EquipVerse Web Release
            
            **Version:** ${{ steps.version.outputs.version }}
            **Build Number:** ${{ steps.version.outputs.build_number }}
            **Commit:** ${{ github.sha }}
            **Renderer:** CanvasKit
            
            ### What's New
            This release was automatically generated from the latest merge to main.
            
            ### Deployment Instructions
            
            #### Deploy to Azure VM (Nginx)
            ```bash
            # Download and extract
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/equipverse-web-${{ steps.version.outputs.version }}.zip
            unzip equipverse-web-${{ steps.version.outputs.version }}.zip
            
            # Deploy to web server
            sudo rm -rf /var/www/equipverse/*
            sudo cp -r web/* /var/www/equipverse/
            sudo chown -R www-data:www-data /var/www/equipverse
            sudo systemctl restart nginx
            ```
            
            #### Deploy to any web server
            1. Download the ZIP file below
            2. Extract the contents
            3. Upload the `web/` folder contents to your web server
            4. Configure your web server to serve the `index.html` file
            5. Ensure all requests fallback to `index.html` for client-side routing
            
            ### Server Configuration Example (Nginx)
            ```nginx
            server {
                listen 80;
                server_name your-domain.com;
                root /var/www/equipverse;
                index index.html;
                
                location / {
                    try_files $uri $uri/ /index.html;
                }
                
                gzip on;
                gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
            }
            ```
            
            ---
            *Built with Flutter on ${{ github.event.head_commit.timestamp }}*
          files: |
            equipverse-web-${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false

      - name: Upload web build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build-${{ steps.version.outputs.version }}
          path: build/web/
          retention-days: 30
